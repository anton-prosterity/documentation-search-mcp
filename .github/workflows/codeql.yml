name: CodeQL

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 3 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  detect-js:
    name: Detect JS/TS sources
    runs-on: ubuntu-latest
    outputs:
      has_js: ${{ steps.detect.outputs.has_js }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for JS/TS files
        id: detect
        run: |
          if git ls-files 'cloudflare/**/*.ts' 'cloudflare/**/*.tsx' 'cloudflare/**/*.js' 'cloudflare/**/*.jsx' | grep -q .; then
            echo "has_js=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_js=false" >> "$GITHUB_OUTPUT"
          fi

  analyze-python:
    name: CodeQL (python)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python

      - name: Analyze
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:python"

  analyze-javascript:
    name: CodeQL (javascript-typescript)
    runs-on: ubuntu-latest
    needs: detect-js
    if: ${{ needs.detect-js.outputs.has_js == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript

      - name: Analyze
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:javascript-typescript"
